# Service Mesh

Service meshes are tools that provide a large feature set for apps. They help streamline and enhance communication between services by securing communication, managing traffic, and monitoring traffic by sending logs to observability tools.

Many of the functionalities we've seen so far can be automated and optimized by service meshes.

Istio is a popular service mesh. It manages service-to-service communication. It provides security, control and observability without touching the application code.

Let's deploy an app to a namespace where Istio is already enabled. It will have use canary deployments.

The deployment and service are as follows:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-dep-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello
      version: v1
  template:
    metadata:
      labels:
        app: hello
        version: v1
    spec:
      containers:
        - name: seedimage
          image: mluukkai/hello:1

---
apiVersion: v1
kind: Service
metadata:
  name: hello-svc-v1
spec:
  type: ClusterIP
  selector:
    app: hello
    version: v1
  ports:
    - port: 80
      protocol: TCP
      targetPort: 8080

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hello-dep-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello
      version: v2
  template:
    metadata:
      labels:
        app: hello
        version: v2
    spec:
      containers:
        - name: seedimage
          image: mluukkai/hello:2

---
apiVersion: v1
kind: Service
metadata:
  name: hello-svc-v2
spec:
  type: ClusterIP
  selector:
    app: hello
    version: v2
  ports:
    - port: 80
      protocol: TCP
      targetPort: 8080
```

The Gateway and HTTPRoute are as follows:

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: hello-gateway
spec:
  gatewayClassName: istio # Note this
  listeners:
    - name: http
      port: 80
      protocol: HTTP
      allowedRoutes:
        namespaces:
          from: Same

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: hello
spec:
  parentRefs:
    - name: hello-gateway
  rules:
    - matches:
        - path:
            type: Exact
            value: /
      backendRefs:
        - name: hello-svc-v1
          port: 80
          weight: 75
        - name: hello-svc-v2
          port: 80
          weight: 25
```

Using Kiali we can visualize this nicely.

The Gateway resource and the ambient mode of Istio are quite new. Certain features might require use to use the older VirtualService resource. To do with, we will need to switch from Gateway resource to Istio Ingress Gateway resource. The resources would look like this:

```yaml
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: hello-gateway
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "*"

---
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: helloworld
spec:
  hosts:
    - "*"
  gateways:
    - hello-gateway
  http:
    - match:
        - uri:
            exact: /
      route:
        - destination:
            host: hello-svc-v1
            port:
              number: 80
          weight: 50
        - destination:
            host: hello-svc-v2
            port:
              number: 80
          weight: 50
```

Then we would acces our app via port-forwarding: `kubectl port-forward svc/istio-ingressgateway 8080:80 -n istio-ingress`.

Under the hood, service meshes often rely on init containers and sidecar containers.

A pod can have multiple init containers, which run before the containers in the pod do. Sidecars are the secondary containers that run alongside the main container.
